# Security Identifier (SID)
Each of the security principals on the system has a unique security identifier(SID).
The system *automatically generates SIDs*. This means that even if, for example, we *have two identical users on the system, Windows can distinguish the two and their rights based on their SIDs*.
SIDs are string values with different lengths, which are stored in the security database.

```powershell
PS C:\htb> whoami /user

USER INFORMATION
----------------

User Name           SID
=================== =============================================
ws01\bob S-1-5-21-674899381-4069889467-2080702030-1002
```

The SID is broken down into this pattern :-
**S-1-5-21-674899381-4069889467-2080702030-1002**
`(SID)-(revision level)-(identifier-authority)-(subauthority1)-(subauthority2)-(etc)`

| Number                            | Meaning                  | Description                                                                                                                                                                                                        |
| --------------------------------- | ------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `S`                               | **SID**                  | Identifies the string as a SID.                                                                                                                                                                                    |
| `1`                               | **Revision Level**       | To date, this has never changed and has always been `1`.                                                                                                                                                           |
| `5`                               | **Identifier-Authority** | A 48-bit string that identifies the authority (the computer or network) that created the SID. SID for *local accounts* is created by *Local Security Authority (LSA)* & for domain users, it is generated by *DC*. |
| `21`                              | **Subauthority1**        | This is a variable number that identifies the user's relation or group described by the SID to the authority that created it. It tells us in what order this authority created the user's account.                 |
| `674899381-4069889467-2080702030` | **Subauthority2**        | Tells us which computer (or domain) created the number.                                                                                                                                                            |
| `1002`                            | **Subauthority3**        | The RID that distinguishes one account from another. Tells us whether this user is a normal user, a guest, an administrator, or part of some other group                                                           |

---
# Mandatory Control Level
It uses *integrity levels* to control access to securable objects. We can think of these levels as hierarchies of trust Windows has in a running application or securable object.

| Integrity Level | Meaning                                                                                                                |
| --------------- | ---------------------------------------------------------------------------------------------------------------------- |
| System          | SYSTEM user                                                                                                            |
| High            | Elevated user                                                                                                          |
| Medium          | Standard user                                                                                                          |
| Low             | Very restricted rights often used in sandboxed processes or for directories storing temporary data                     |
| Untrusted       | Lowest integrity level with extremely limited access rights for processes or objects that pose the most potential risk |

---
# User Account Control (UAC)
User Account Control (UAC) is a security feature in Windows to prevent malware from running or manipulating processes that could damage the computer or its contents. There is the *Admin Approval Mode in UAC*, which is *designed to prevent unwanted software from being installed without the administrator's knowledge* or to prevent system-wide changes from being made.
Surely you have already *seen the consent prompt if you have installed a specific software, and your system has asked for confirmation* if you want to have it installed. Since the installation *requires administrator rights, a window pops up, asking you if you want to confirm the installation*.
With a *standard user who has no rights for the installation, execution will be denied, or you will be asked for the administrator password*.
This consent *prompt interrupts the execution of scripts or binaries* that malware or attackers try to execute until the user enters the password or confirms execution.
For this, an administrative user obtains **two access tokens** after a successful logon. The first token is a <u>standard user token</u> (or filtered admin token), which is used to perform all non-privileged operations. The second token is a <u>regular administrator token</u>. It will be used when the user wants to perform a privileged operation. To leverage the administrator token, a UAC consent prompt needs to be confirmed.

---
# Registry
**Registry** stores *low-level settings for the Windows OS and applications* that choose to use it.

![[Pasted image 20230608113340.png]]

The <mark style="background: #BBFABBA6;">tree-structure</mark> consists of **main folders (root keys) in which subfolders (subkeys) with their entries/files (values) are located**. There are `11` different types of values that can be *entered in a subkey* :-

| Value                   | Type                                                                                                                                                                                                                                                                                                                                                                               |
| ----------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **REG_BINARY**              | Binary data in any form.                                                                                                                                                                                                                                                                                                                                                           |
| **REG_DWORD**               | A 32-bit number.                                                                                                                                                                                                                                                                                                                                                                   |
| **REG_DWORD_LITTLE_ENDIAN** | A 32-bit number in little-endian format. Windows is designed to run on little-endian computer architectures. Therefore, this value is defined as REG_DWORD in the Windows header files.                                                                                                                                                                                            |
| **REG_DWORD_BIG_ENDIAN**    | A 32-bit number in big-endian format. Some UNIX systems support big-endian architectures.                                                                                                                                                                                                                                                                                          |
| **REG_EXPAND_SZ**           | A null-terminated string that contains unexpanded references to environment variables (for example, "%PATH%"). It will be a Unicode or ANSI string depending on whether you use the Unicode or ANSI functions.                                                                                                                                                                     |
| **REG_LINK**                | A null-terminated Unicode string containing the target path of a symbolic link created by calling the RegCreateKeyEx function with REG_OPTION_CREATE_LINK.                                                                                                                                                                                                                         |
| **REG_MULTI_SZ**            | A sequence of null-terminated strings, terminated by an empty string (\0). The following is an example: _String1_\0_String2_\0_String3_\0_LastString_\0\0 The first \0 terminates the first string, the second to the last \0 terminates the last string, and the final \0 terminates the sequence. Note that the final terminator must be factored into the length of the string. |
| **REG_NONE**                | No defined value type.                                                                                                                                                                                                                                                                                                                                                             |
| **REG_QWORD**               | A 64-bit number.                                                                                                                                                                                                                                                                                                                                                                   |
| **REG_QWORD_LITTLE_ENDIAN** | A 64-bit number in little-endian format. Windows is designed to run on little-endian computer architectures. Therefore, this value is defined as REG_QWORD in the Windows header files.                                                                                                                                                                                            |
| **REG_SZ**                  | A null-terminated string. This will be either a Unicode or an ANSI string, depending on whether you use the Unicode or ANSI functions.                                                                                                                                                                                                                                                                                                                                                                                   |


Each folder under `Computer` is a key. The root keys all start with `HKEY`. A key such as `HKEY-LOCAL-MACHINE` is abbreviated to `HKLM`. HKLM contains all settings that are relevant to the local system. This root key contains six subkeys like `SAM`, `SECURITY`, `SYSTEM`, `SOFTWARE`, `HARDWARE`, and `BCD`, loaded into memory at boot time (except `HARDWARE` which is dynamically loaded).

![[Pasted image 20230608115015.png]]

The **entire system registry is stored in** several files on the operating system. You can find these under `C:\Windows\System32\Config\`.

The **user-specific registry hive (HKCU) is stored in** the user folder (i.e., `C:\Windows\Users\<USERNAME>\Ntuser.dat`).


#### Run and Run-Once Registry Keys
Use `Run` or `RunOnce` registry keys to make a program run when a user logs on. The `Run` key makes the program *run every time the user logs on*, while the `RunOnce` key makes the *program run one time, and then the key is deleted*. These keys can be set for the user or the machine.

The Windows registry includes the following `four` keys:
```powershell
HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run
HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run
HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnce
HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce
```


Here is an example of the `HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run` showing applications running under the current user while logged in to a system.
```powershell
PS C:\htb> reg query HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run

HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run
    OneDrive    REG_SZ    "C:\Users\bob\AppData\Local\Microsoft\OneDrive\OneDrive.exe" /background
    OPENVPN-GUI    REG_SZ    C:\Program Files\OpenVPN\bin\openvpn-gui.exe
    Docker Desktop    REG_SZ    C:\Program Files\Docker\Docker\Docker Desktop.exe
```


`Get-MpComputerStatus` to check which protection settings are enabled.
```powershell
PS C:\htb> Get-MpComputerStatus | findstr "True"
AMServiceEnabled                : True
AntispywareEnabled              : True
AntivirusEnabled                : True
BehaviorMonitorEnabled          : True
IoavProtectionEnabled           : True
IsTamperProtected               : True
NISEnabled                      : True
OnAccessProtectionEnabled       : True
RealTimeProtectionEnabled       : True
```